---
phase: 02-matching-engine-auto-reconciliation
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - models/mass_reconcile_engine.py
  - models/mass_reconcile_scorer.py
  - models/__init__.py
  - tests/__init__.py
  - tests/test_matching_engine.py
autonomous: true

must_haves:
  truths:
    - "Engine finds unreconciled move lines matching statement line amount using float_compare"
    - "Engine filters candidates by partner when partner is identified on statement line"
    - "Engine filters candidates within configurable date range (+/- N days)"
    - "Engine compares payment_ref between statement line and move line (exact + substring)"
    - "Engine detects internal transfers between bank accounts of same company"
    - "Engine excludes already-reconciled move lines from candidates"
    - "Scorer produces weighted confidence score 0-100 per candidate"
    - "Candidates with score 100 classified as safe, 80-99 as probable, below 80 as doubtful"
  artifacts:
    - path: "models/mass_reconcile_engine.py"
      provides: "Multi-stage candidate search pipeline"
      contains: "class MassReconcileEngine"
    - path: "models/mass_reconcile_scorer.py"
      provides: "Weighted confidence scoring algorithm"
      contains: "class MassReconcileScorer"
    - path: "tests/test_matching_engine.py"
      provides: "TDD tests for engine and scorer"
      contains: "class TestMatchingEngine"
  key_links:
    - from: "models/mass_reconcile_engine.py"
      to: "account.move.line"
      via: "ORM search with domain filters"
      pattern: "env\\['account\\.move\\.line'\\]\\.search"
    - from: "models/mass_reconcile_engine.py"
      to: "models/mass_reconcile_scorer.py"
      via: "scorer invocation for each candidate"
      pattern: "env\\['mass\\.reconcile\\.scorer'\\]"
    - from: "models/mass_reconcile_scorer.py"
      to: "fields.Float"
      via: "float_compare for monetary precision"
      pattern: "float_compare|float_is_zero|Float\\.compare|Float\\.is_zero"
---

<objective>
Implement the core matching engine and confidence scorer using TDD. The engine searches for reconciliation candidates from account.move.line by exact amount, partner, reference, and date range. The scorer calculates a weighted confidence score (0-100) combining amount match (50%), partner match (25%), reference match (20%), and date proximity (5%). Internal transfer detection identifies matching transactions between company bank accounts.

Purpose: This is the algorithmic heart of the module -- without accurate candidate search and reliable confidence scoring, mass reconciliation cannot function. TDD ensures the scoring algorithm and search logic are correct before wiring into the batch flow.

Output: Two tested model files (engine + scorer), integrated into models/__init__.py, with passing test suite.
</objective>

<execution_context>
@/home/jojeda/.claude/get-shit-done/workflows/execute-plan.md
@/home/jojeda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-models-data-layer/01-01-SUMMARY.md
@.planning/phases/02-matching-engine-auto-reconciliation/02-RESEARCH.md
@models/mass_reconcile_batch.py
@models/mass_reconcile_match.py
@models/account_bank_statement_line.py
@models/__init__.py
</context>

<!-- NOTE: This is a TDD plan (type: tdd). TDD plans use <feature><behavior><implementation>
     structure instead of <tasks>. This is the expected format per gsd-planner conventions.
     The gsd-tools "No <task> elements found" warning is expected and can be ignored for TDD plans. -->

<feature>
  <name>Matching Engine + Confidence Scorer</name>
  <files>
    models/mass_reconcile_engine.py
    models/mass_reconcile_scorer.py
    models/__init__.py
    tests/__init__.py
    tests/test_matching_engine.py
  </files>
  <behavior>
    The matching engine and scorer work together to find and rank reconciliation candidates.

    **Engine (mass.reconcile.engine) behavior:**

    1. `find_candidates(statement_line)` returns a list of scored candidate dicts:
       - Input: a single account.bank.statement.line record
       - Output: list of dicts `[{move_line_id, score, match_type, reason}]` sorted by score desc

    2. Candidate search domain MUST include:
       - `('full_reconcile_id', '=', False)` -- not already reconciled (MATCH-11)
       - `('account_id.reconcile', '=', True)` -- reconcilable account
       - `('parent_state', '=', 'posted')` -- only posted moves
       - `('company_id', '=', statement_line.company_id.id)` -- same company
       - Amount filtering via float_compare with currency precision (MATCH-01, MATCH-10)

    3. Partner filtering (MATCH-02):
       - When statement_line.partner_id is set, add `('partner_id', '=', partner_id)` to domain
       - When no partner, search without partner filter (wider search)

    4. Date range filtering (MATCH-04):
       - Configurable `date_range_days` field (default 30)
       - Filter: statement_line.date +/- date_range_days
       - Domain: `('date', '>=', date_from), ('date', '<=', date_to)`

    5. Reference comparison (MATCH-03):
       - Compare statement_line.payment_ref vs move_line.payment_ref or move_line.ref
       - Exact match: 100 points for reference factor
       - Substring match (one contains other): 75 points
       - No match or missing refs: 0 points

    6. Internal transfer detection (MATCH-05):
       - `detect_internal_transfers(statement_line)` searches OTHER bank journals
       - Looks for opposite amount in same company, different bank journal
       - Date range +/- 7 days (configurable)
       - Returns candidates with match_type='internal_transfer'

    **Scorer (mass.reconcile.scorer) behavior:**

    7. `calculate_score(statement_line, move_line)` returns float 0-100:
       - Weights: amount=0.50, partner=0.25, reference=0.20, date=0.05
       - Amount score: 100 if float_compare==0, else 0 (MATCH-10)
       - Partner score: 100 if both set and match, 50 if move has partner but line doesn't, 0 otherwise
       - Reference score: 100 exact, 75 substring, 0 no match (MATCH-03)
       - Date score: 100 if same day, linear decay to 0 at date_range_days boundary

    8. `classify_match(score)` returns classification string (MATCH-07, 08, 09):
       - score == 100.0 -> 'safe'
       - 80.0 <= score < 100.0 -> 'probable'
       - score < 80.0 -> 'doubtful'

    **Test cases (RED phase):**

    - test_exact_amount_match: statement line 1000.00, move line 1000.00 -> found in candidates
    - test_amount_mismatch: statement line 1000.00, no move line with 1000.00 -> empty candidates
    - test_float_precision: statement line 0.10 + 0.20, move line 0.30 -> match found (float_compare)
    - test_partner_filter: with partner set, only matching partner move lines returned
    - test_no_partner_wider_search: without partner, all amount-matching lines returned
    - test_date_range_filter: move line outside date range excluded
    - test_reference_exact_match: matching payment_ref -> reference score 100
    - test_reference_substring_match: partial ref match -> reference score 75
    - test_already_reconciled_excluded: move line with full_reconcile_id -> excluded
    - test_draft_move_excluded: move in draft state -> excluded
    - test_internal_transfer_detection: opposite amount in other bank journal -> detected
    - test_score_safe_classification: score 100 -> 'safe'
    - test_score_probable_classification: score 85 -> 'probable'
    - test_score_doubtful_classification: score 60 -> 'doubtful'
    - test_weighted_score_calculation: verify weight formula produces expected score
  </behavior>
  <implementation>
    **RED phase:**
    1. Create tests/__init__.py (empty)
    2. Create tests/test_matching_engine.py with TransactionCase test class
    3. Set up test fixtures: create test company, bank journal, statement lines, move lines with various characteristics
    4. Write all test methods listed above (they will fail because engine/scorer don't exist)
    5. Run tests to confirm RED state

    **GREEN phase:**
    1. Create models/mass_reconcile_engine.py:
       - AbstractModel `mass.reconcile.engine` (no database table, pure logic)
       - Field: date_range_days = fields.Integer(default=30)
       - Method: find_candidates(statement_line) -> list of scored dicts
       - Method: _search_amount_candidates(statement_line) -> recordset of move lines
       - Method: _detect_internal_transfers(statement_line) -> list of scored dicts
       - Method: _build_base_domain(statement_line) -> domain list
       - All searches use float_compare/float_is_zero from odoo.tools.float_utils
       - Import: `from odoo.tools.float_utils import float_compare, float_is_zero`

    2. Create models/mass_reconcile_scorer.py:
       - AbstractModel `mass.reconcile.scorer` (no database table, pure logic)
       - Class constants: WEIGHTS dict with amount/partner/reference/date weights
       - Method: calculate_score(statement_line, move_line) -> float
       - Method: classify_match(score) -> str ('safe'/'probable'/'doubtful')
       - Method: _score_amount(st_line, mv_line) -> float
       - Method: _score_partner(st_line, mv_line) -> float
       - Method: _score_reference(st_line, mv_line) -> float
       - Method: _score_date(st_line, mv_line) -> float
       - Use float_compare for amount scoring (MATCH-10)
       - Use currency_id.rounding for precision (never hardcode)

    3. Update models/__init__.py to import both new modules

    4. Run tests to confirm GREEN state

    **REFACTOR phase (if needed):**
    - Extract common domain-building logic
    - Ensure no code duplication between engine stages
    - Verify all anti-patterns from research are avoided (no Python == for floats, no search in loops, no hardcoded precision)
  </implementation>
</feature>

<verification>
```bash
# Tests pass
cd /home/jojeda/claude/mass_reconcile && python -m pytest tests/test_matching_engine.py -v 2>&1 || python -c "import ast; ast.parse(open('models/mass_reconcile_engine.py').read()); ast.parse(open('models/mass_reconcile_scorer.py').read()); print('Syntax OK')"

# Verify float_compare usage (no raw == on floats)
grep -n "float_compare\|float_is_zero\|Float.compare\|Float.is_zero" models/mass_reconcile_engine.py models/mass_reconcile_scorer.py

# Verify already-reconciled exclusion
grep -n "full_reconcile_id" models/mass_reconcile_engine.py

# Verify posted state filter
grep -n "parent_state" models/mass_reconcile_engine.py

# Verify models/__init__.py imports new modules
grep "mass_reconcile_engine\|mass_reconcile_scorer" models/__init__.py
```
</verification>

<success_criteria>
- All test cases pass (or all Python files have valid syntax if Odoo test runner unavailable)
- mass.reconcile.engine has find_candidates() returning scored candidate list
- mass.reconcile.scorer has calculate_score() returning 0-100 and classify_match() returning safe/probable/doubtful
- float_compare or float_is_zero used for ALL monetary comparisons (zero raw == on floats)
- All candidate searches include full_reconcile_id=False and parent_state=posted filters
- Internal transfer detection searches opposite amount in other bank journals
- Reference scoring handles exact match (100), substring (75), and no match (0)
- Date range is configurable via date_range_days field
- models/__init__.py imports both new modules
</success_criteria>

<output>
After completion, create `.planning/phases/02-matching-engine-auto-reconciliation/02-01-SUMMARY.md`
</output>
