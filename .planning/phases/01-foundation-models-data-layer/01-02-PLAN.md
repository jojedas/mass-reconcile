---
phase: 01-foundation-models-data-layer
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - security/ir.model.access.csv
  - security/mass_reconcile_security.xml
  - __manifest__.py
autonomous: true

must_haves:
  truths:
    - "Accounting users (group_account_user) can read/write/create batches and matches but not delete"
    - "Accounting managers (group_account_manager) have full CRUD on all reconciliation models"
    - "Users can only see batches belonging to their company (multi-company isolation)"
    - "Module manifest declares security files so they load on install/upgrade"
  artifacts:
    - path: "security/ir.model.access.csv"
      provides: "Model-level access rights for batch and match models"
      contains: "access_mass_reconcile_batch"
      min_lines: 5
    - path: "security/mass_reconcile_security.xml"
      provides: "Record rules for multi-company isolation"
      contains: "ir.rule"
      min_lines: 10
    - path: "__manifest__.py"
      provides: "Updated manifest with security data files"
      contains: "ir.model.access.csv"
  key_links:
    - from: "security/ir.model.access.csv"
      to: "models/mass_reconcile_batch.py"
      via: "model_id:id reference to model_mass_reconcile_batch"
      pattern: "model_mass_reconcile_batch"
    - from: "security/ir.model.access.csv"
      to: "models/mass_reconcile_match.py"
      via: "model_id:id reference to model_mass_reconcile_match"
      pattern: "model_mass_reconcile_match"
    - from: "security/mass_reconcile_security.xml"
      to: "models/mass_reconcile_batch.py"
      via: "Record rule domain filtering by company_id"
      pattern: "company_id.*company_ids"
    - from: "__manifest__.py"
      to: "security/ir.model.access.csv"
      via: "data list includes security CSV"
      pattern: "security/ir.model.access.csv"
---

<objective>
Create the security layer for mass reconciliation models: model-level access rights via CSV and row-level record rules via XML for multi-company isolation.

Purpose: Prevent unauthorized access to reconciliation data and ensure multi-company isolation, satisfying DATA-05 (security model) requirements.
Output: Security CSV with access rights for accounting user/manager groups, XML record rules for company isolation, and updated module manifest.
</objective>

<execution_context>
@/home/jojeda/.claude/get-shit-done/workflows/execute-plan.md
@/home/jojeda/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-models-data-layer/01-RESEARCH.md
@.planning/phases/01-foundation-models-data-layer/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create security access rights and record rules</name>
  <files>
    security/ir.model.access.csv
    security/mass_reconcile_security.xml
  </files>
  <action>
    1. Create `security/ir.model.access.csv` with the following access rights:

       Header: id,name,model_id:id,group_id:id,perm_read,perm_write,perm_create,perm_unlink

       For mass.reconcile.batch:
       - access_mass_reconcile_batch_user: group account.group_account_user gets read(1), write(1), create(1), unlink(0)
       - access_mass_reconcile_batch_manager: group account.group_account_manager gets full CRUD (1,1,1,1)

       For mass.reconcile.match:
       - access_mass_reconcile_match_user: group account.group_account_user gets read(1), write(1), create(1), unlink(0)
       - access_mass_reconcile_match_manager: group account.group_account_manager gets full CRUD (1,1,1,1)

       Note: account.bank.statement.line already has access rights from the account module. Our extension fields inherit the same permissions. No need to add access rights for the extension.

       Use the Odoo model_id:id naming convention: model_{model_name_with_underscores}. For mass.reconcile.batch -> model_mass_reconcile_batch. For mass.reconcile.match -> model_mass_reconcile_match.

    2. Create `security/mass_reconcile_security.xml` with record rules for multi-company isolation:

       ```xml
       <?xml version="1.0" encoding="utf-8"?>
       <odoo>
           <!-- Multi-company record rules -->
           <record id="mass_reconcile_batch_company_rule" model="ir.rule">
               <field name="name">Mass Reconcile Batch: multi-company</field>
               <field name="model_id" ref="model_mass_reconcile_batch"/>
               <field name="domain_force">[('company_id', 'in', company_ids)]</field>
           </record>

           <record id="mass_reconcile_match_company_rule" model="ir.rule">
               <field name="name">Mass Reconcile Match: multi-company</field>
               <field name="model_id" ref="model_mass_reconcile_match"/>
               <field name="domain_force">[('batch_id.company_id', 'in', company_ids)]</field>
           </record>
       </odoo>
       ```

       Key details:
       - Use `company_ids` (not `company_id`) in domain_force -- this is Odoo 18.0's multi-company variable that includes all companies the user has access to
       - No group_id specified on the rules (applies to all groups)
       - Match model rule traverses via batch_id.company_id since match doesn't have its own company_id field
       - Do NOT add noupdate="1" -- these rules should be updatable on module upgrade
  </action>
  <verify>
    Verify CSV has correct header and 4 data rows (2 per model, user + manager).
    Verify XML is well-formed: `python -c "import xml.etree.ElementTree as ET; ET.parse('security/mass_reconcile_security.xml'); print('XML OK')"`.
    Verify CSV references match model names: model_mass_reconcile_batch, model_mass_reconcile_match.
    Verify record rules use company_ids (plural) not company_id.
  </verify>
  <done>
    Security CSV defines 4 access rights (batch user/manager, match user/manager) with appropriate permissions (users cannot delete, managers have full CRUD). XML record rules enforce multi-company isolation for both batch and match models using company_ids.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update module manifest with security data files</name>
  <files>
    __manifest__.py
  </files>
  <action>
    Update `__manifest__.py` to include security files in the 'data' list:

    ```python
    'data': [
        'security/ir.model.access.csv',
        'security/mass_reconcile_security.xml',
    ],
    ```

    The order matters: CSV must come before XML because:
    - ir.model.access.csv loads access rights first (needed for security context)
    - mass_reconcile_security.xml loads record rules that reference models

    Ensure no other changes to the manifest beyond adding the data entries.
    Read the existing __manifest__.py first (created by Plan 01) and only modify the 'data' key.
  </action>
  <verify>
    Run: `python -c "import ast; m = ast.literal_eval(open('__manifest__.py').read()); assert 'security/ir.model.access.csv' in m['data']; assert 'security/mass_reconcile_security.xml' in m['data']; print('MANIFEST OK')"`.
    Verify data list has CSV before XML.
  </verify>
  <done>
    Module manifest includes both security files in correct order (CSV before XML). Module is ready for installation with proper security configuration.
  </done>
</task>

</tasks>

<verification>
1. CSV file has correct header and 4 access right entries
2. XML file passes well-formedness check
3. Record rules use `company_ids` (Odoo 18.0 multi-company)
4. Manifest data list includes both security files in correct order
5. User group (group_account_user) has read/write/create but NOT delete
6. Manager group (group_account_manager) has full CRUD
7. Multi-company isolation works via company_id on batch and batch_id.company_id on match
</verification>

<success_criteria>
- All security files exist and are syntactically valid
- Access rights cover both new models (batch and match) for both user groups
- Record rules enforce multi-company isolation
- Module manifest correctly references security files
- Security follows Odoo best practices: CSV for model access, XML for record rules
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-models-data-layer/01-02-SUMMARY.md`
</output>
